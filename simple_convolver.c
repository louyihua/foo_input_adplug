#include "simple_convolver.h"

#include <stdlib.h>
#include <string.h>
#include <math.h>

#include "kissfft/kiss_fftr.h"

enum { null_impulse_size = 1 };

static const float null_impulse[null_impulse_size] = { 1.0 };

enum { ess_impulse_size = 1024 };

static const float ess_impulse[ess_impulse_size] =
{
 0.5087133366, 0.3896014709,-0.0927233491, 0.0861962818,-0.0752845951, 0.0167188455, 0.0175456003,-0.0403751024,
 0.0471415835,-0.0459099942, 0.0422922689,-0.0337571728, 0.0228196982,-0.0129045040, 0.0003180965, 0.0078119927,
-0.0164779429, 0.0217162832,-0.0230879462, 0.0233188822,-0.0223269903, 0.0173114377,-0.0130560101, 0.0070937481,
-0.0015269472,-0.0053144139, 0.0083248552,-0.0134792211, 0.0146965414,-0.0163021106, 0.0151734686,-0.0135714481,
 0.0109469627,-0.0068710167, 0.0037212213, 0.0009756788,-0.0040825003, 0.0073957014,-0.0098443473, 0.0109677840,
-0.0119984954, 0.0108774002,-0.0103145178, 0.0075253170,-0.0056953385, 0.0021399961, 0.0001104814,-0.0036633663,
 0.0051882584,-0.0080623192, 0.0082223963,-0.0097109447, 0.0086269081,-0.0083149215, 0.0064404350,-0.0046332357,
 0.0024638135, 0.0000210194,-0.0020088435, 0.0042558866,-0.0056925393, 0.0069088416,-0.0075447726, 0.0073519555,
-0.0070812461, 0.0056342346,-0.0045703146, 0.0024047912,-0.0009316191,-0.0013905628, 0.0027473585,-0.0046361818,
 0.0053436202,-0.0063418262, 0.0062118405,-0.0062054467, 0.0052954602,-0.0043480995, 0.0028503744,-0.0013633278,
-0.0003121274, 0.0017924446,-0.0032338561, 0.0042318971,-0.0051863037, 0.0053184745,-0.0056128372, 0.0047043291,
-0.0044419818, 0.0027814144,-0.0021920843, 0.0001055607, 0.0005780998,-0.0025895833, 0.0029590881,-0.0044374030,
 0.0042999304,-0.0050871699, 0.0043758440,-0.0043419189, 0.0030773556,-0.0024523306, 0.0009586206,-0.0000548806,
-0.0014405148, 0.0022211710,-0.0033512486, 0.0037118529,-0.0043212417, 0.0040456603,-0.0040587378, 0.0031926633,
-0.0027292556, 0.0014410810,-0.0007156869,-0.0006691957, 0.0013999479,-0.0025560288, 0.0029869011,-0.0037083693,
 0.0036769361,-0.0038023706, 0.0032682988,-0.0028850459, 0.0019440266,-0.0012123529, 0.0000927140, 0.0006710166,
-0.0017669769, 0.0022537278,-0.0030856632, 0.0031306651,-0.0035325033, 0.0030574519,-0.0030445314, 0.0020814837,
-0.0017649873, 0.0005343844,-0.0000647617,-0.0011697483, 0.0015294530,-0.0025382970, 0.0026236785,-0.0032019642,
 0.0028942996,-0.0030106048, 0.0023217377,-0.0020190549, 0.0011029390,-0.0005551539,-0.0004157376, 0.0009680603,
-0.0018156937, 0.0021468485,-0.0026782305, 0.0026813151,-0.0027863683, 0.0024147434,-0.0021680293, 0.0014658954,
-0.0009755342, 0.0001168467, 0.0004278238,-0.0012450097, 0.0016391801,-0.0022352545, 0.0023472219,-0.0026319317,
 0.0023458260,-0.0023133646, 0.0016799252,-0.0013927992, 0.0005568835,-0.0001709591,-0.0007398634, 0.0010292851,
-0.0018307302, 0.0018564873,-0.0024132795, 0.0020946470,-0.0023662631, 0.0017187288,-0.0017115316, 0.0008043202,
-0.0006584785,-0.0003513734, 0.0004841604,-0.0014169339, 0.0014304114,-0.0021349261, 0.0018830542,-0.0023004806,
 0.0017568210,-0.0018846312, 0.0011195194,-0.0010025234, 0.0001364504, 0.0000668064,-0.0008992746, 0.0010341165,
-0.0017025839, 0.0016471766,-0.0020443416, 0.0017482428,-0.0018545377, 0.0013319517,-0.0011999031, 0.0005107035,
-0.0002747396,-0.0004564995, 0.0006766387,-0.0013062719, 0.0013897739,-0.0018037924, 0.0016618992,-0.0018432102,
 0.0014383080,-0.0014009770, 0.0008046722,-0.0006214167,-0.0000543313, 0.0002695963,-0.0009098762, 0.0010142170,
-0.0015244610, 0.0014336410,-0.0017271873, 0.0014194535,-0.0014770106, 0.0009783082,-0.0008638728, 0.0002436251,
-0.0000677042,-0.0005690225, 0.0007068661,-0.0012232361, 0.0012414665,-0.0015580659, 0.0013839694,-0.0014948892,
 0.0011184839,-0.0010559760, 0.0005374647,-0.0003555549,-0.0001871924, 0.0003950703,-0.0008684820, 0.0009772771,
-0.0013167767, 0.0012580399,-0.0014091152, 0.0011585426,-0.0011255790, 0.0007234001,-0.0005689019, 0.0000753333,
 0.0001032503,-0.0005986957, 0.0007208761,-0.0011069360, 0.0010947553,-0.0013274211, 0.0011340843,-0.0012196624,
 0.0008384739,-0.0008011489, 0.0003004708,-0.0001992419,-0.0003218669, 0.0004029077,-0.0008691169, 0.0008432068,
-0.0011974345, 0.0010039791,-0.0012033577, 0.0008582787,-0.0009165244, 0.0004433832,-0.0004244692,-0.0001209551,
 0.0001455756,-0.0006611320, 0.0006306428,-0.0010355385, 0.0009073926,-0.0011541117, 0.0008815798,-0.0009983862,
 0.0005818449,-0.0006069518, 0.0001138434,-0.0000804514,-0.0003938130, 0.0004134726,-0.0008112077, 0.0007420720,
-0.0010278635, 0.0008279991,-0.0009761530, 0.0006590203,-0.0006859669, 0.0002827310,-0.0002407449,-0.0001905955,
 0.0002300584,-0.0006223291, 0.0006054979,-0.0008938405, 0.0007860721,-0.0009392441, 0.0007133464,-0.0007663888,
 0.0004231536,-0.0004083407, 0.0000170097, 0.0000308004,-0.0004011587, 0.0004186036,-0.0007266525, 0.0006486913,
-0.0008610281, 0.0006703300,-0.0007765278, 0.0004862966,-0.0004970144, 0.0001473705,-0.0001186848,-0.0002542884,
 0.0002553557,-0.0005955730, 0.0005323234,-0.0007851912, 0.0006350968,-0.0007864646, 0.0005269105,-0.0006058333,
 0.0002562532,-0.0002907747,-0.0000945753, 0.0000711147,-0.0004343100, 0.0003699762,-0.0006739384, 0.0005157771,
-0.0007515103, 0.0004903159,-0.0006423738, 0.0003046032,-0.0003848062, 0.0000019514,-0.0000698632,-0.0003297998,
 0.0002224061,-0.0005933795, 0.0004251000,-0.0007166428, 0.0004692130,-0.0006804757, 0.0003444553,-0.0005039976,
 0.0000960894,-0.0002290011,-0.0002002629, 0.0000681781,-0.0004592892, 0.0002914704,-0.0006297652, 0.0003807308,
-0.0006616451, 0.0003240995,-0.0005382019, 0.0001491378,-0.0003020298,-0.0001013610,-0.0000332397,-0.0003685368,
 0.0001952274,-0.0005595878, 0.0003330658,-0.0006276600, 0.0003428430,-0.0005610122, 0.0002177887,-0.0003864387,
 0.0000029767,-0.0001473038,-0.0002322556, 0.0000933619,-0.0004275268, 0.0002581005,-0.0005376472, 0.0003074324,
-0.0005286040, 0.0002375007,-0.0003953313, 0.0000797862,-0.0001849137,-0.0001305088, 0.0000365965,-0.0003364539,
 0.0002096093,-0.0004701706, 0.0003018238,-0.0004928915, 0.0002859835,-0.0004118829, 0.0001627439,-0.0002536536,
-0.0000244072,-0.0000521841,-0.0002130926, 0.0001366465,-0.0003532422, 0.0002571594,-0.0004196795, 0.0002691677,
-0.0003892170, 0.0001870912,-0.0002654896, 0.0000418252,-0.0000887836,-0.0001339121, 0.0000856880,-0.0002910906,
 0.0002135475,-0.0003799109, 0.0002668517,-0.0003762968, 0.0002330558,-0.0002944079, 0.0001103347,-0.0001573706,
-0.0000527665, 0.0000032331,-0.0001998531, 0.0001473433,-0.0003009290, 0.0002234693,-0.0003372662, 0.0002093704,
-0.0002956192, 0.0001254488,-0.0001828994,-0.0000007269,-0.0000326927,-0.0001449154, 0.0000993782,-0.0002671357,
 0.0001826203,-0.0003278150, 0.0002074367,-0.0003059328, 0.0001630356,-0.0002216353, 0.0000536578,-0.0001059908,
-0.0000813715, 0.0000218534,-0.0001981941, 0.0001254570,-0.0002674960, 0.0001717262,-0.0002801545, 0.0001483429,
-0.0002314677, 0.0000674997,-0.0001290082,-0.0000402898,-0.0000071383,-0.0001539412, 0.0000922868,-0.0002460302,
 0.0001476216,-0.0002787841, 0.0001554970,-0.0002471567, 0.0001065236,-0.0001716481, 0.0000099240,-0.0000742261,
-0.0000991060, 0.0000272068,-0.0001850517, 0.0001085484,-0.0002259883, 0.0001367177,-0.0002261371, 0.0001028377,
-0.0001814951, 0.0000261919,-0.0000962850,-0.0000628806, 0.0000015958,-0.0001504434, 0.0000756640,-0.0002166947,
 0.0001116832,-0.0002350695, 0.0001082359,-0.0002007197, 0.0000635249,-0.0001318431,-0.0000148349,-0.0000536164,
-0.0001040771, 0.0000238197,-0.0001669043, 0.0000790318,-0.0001941208, 0.0000907805,-0.0001896240, 0.0000534778,
-0.0001502915,-0.0000122902,-0.0000799041,-0.0000836974,-0.0000040559,-0.0001514550, 0.0000491882,-0.0002004283,
 0.0000706708,-0.0002076406, 0.0000620161,-0.0001703624, 0.0000261048,-0.0001115510,-0.0000405962,-0.0000508386,
-0.0001145663, 0.0000020928,-0.0001640109, 0.0000415170,-0.0001816869, 0.0000472357,-0.0001730690, 0.0000136514,
-0.0001384472,-0.0000403016,-0.0000820551,-0.0000973690,-0.0000213629,-0.0001489744, 0.0000199256,-0.0001820049,
 0.0000352213,-0.0001837285, 0.0000288117,-0.0001527624,-0.0000045699,-0.0001078429,-0.0000583915,-0.0000612829,
-0.0001132483,-0.0000160594,-0.0001475905, 0.0000176628,-0.0001576338, 0.0000190825,-0.0001538068,-0.0000123686,
-0.0001290596,-0.0000549516,-0.0000807270,-0.0000928179,-0.0000283443,-0.0001280551, 0.0000054183,-0.0001543974,
 0.0000155976,-0.0001570813, 0.0000108960,-0.0001314251,-0.0000112823,-0.0000936781,-0.0000525934,-0.0000576775,
-0.0000956102,-0.0000220471,-0.0001226567, 0.0000053849,-0.0001294668, 0.0000097328,-0.0001249515,-0.0000108961,
-0.0001057467,-0.0000421909,-0.0000686756,-0.0000721420,-0.0000274876,-0.0001009493,-0.0000006748,-0.0001233069,
 0.0000100189,-0.0001261353, 0.0000108474,-0.0001049505,-0.0000042009,-0.0000770857,-0.0000359131,-0.0000509942,
-0.0000728642,-0.0000233252,-0.0000960041, 0.0000011100,-0.0001025662, 0.0000099548,-0.0001007529,-0.0000025372,
-0.0000882615,-0.0000261064,-0.0000599142,-0.0000488065,-0.0000265235,-0.0000721555,-0.0000047009,-0.0000939218,
 0.0000060912,-0.0000994471, 0.0000065971,-0.0000880388,-0.0000027676,-0.0000674175,-0.0000263861,-0.0000444369,
-0.0000545555,-0.0000198049,-0.0000735725, 0.0000032126,-0.0000838201, 0.0000106102,-0.0000879729,-0.0000007936,
-0.0000806336,-0.0000171277,-0.0000566999,-0.0000343528,-0.0000291278,-0.0000579903,-0.0000110283,-0.0000802421,
-0.0000015294,-0.0000895452, 0.0000045559,-0.0000795366, 0.0000007488,-0.0000623125,-0.0000192629,-0.0000456198,
-0.0000465037,-0.0000241752,-0.0000649835,-0.0000014493,-0.0000751314, 0.0000080517,-0.0000828457,-0.0000004561,
-0.0000815562,-0.0000157782,-0.0000639399,-0.0000306515,-0.0000375232,-0.0000492805,-0.0000168249,-0.0000687865,
-0.0000053289,-0.0000783341, 0.0000021909,-0.0000729820,-0.0000016154,-0.0000611999,-0.0000208552,-0.0000491207,
-0.0000464840,-0.0000308869,-0.0000645405,-0.0000090751,-0.0000744370, 0.0000017604,-0.0000807079,-0.0000029063,
-0.0000787774,-0.0000154588,-0.0000626757,-0.0000295022,-0.0000386257,-0.0000481140,-0.0000220992,-0.0000683229,
-0.0000124550,-0.0000785850,-0.0000055260,-0.0000729176,-0.0000089422,-0.0000619027,-0.0000266755,-0.0000501696,
-0.0000516731,-0.0000329273,-0.0000697452,-0.0000127912,-0.0000788705,-0.0000023904,-0.0000837479,-0.0000063510,
-0.0000799929,-0.0000175380,-0.0000633136,-0.0000316567,-0.0000421360,-0.0000498588,-0.0000267949,-0.0000707017,
-0.0000184136,-0.0000795537,-0.0000130817,-0.0000734631,-0.0000160664,-0.0000627417,-0.0000349135,-0.0000510543,
-0.0000587127,-0.0000349543,-0.0000738012,-0.0000152581,-0.0000807009,-0.0000059485,-0.0000844611,-0.0000119705,
-0.0000816340,-0.0000250062,-0.0000665944,-0.0000379788,-0.0000449587,-0.0000539369,-0.0000301744,-0.0000705036,
-0.0000237726,-0.0000783581,-0.0000219523,-0.0000725484,-0.0000274660,-0.0000608741,-0.0000441156,-0.0000487966,
-0.0000646508,-0.0000335607,-0.0000773313,-0.0000180897,-0.0000822003,-0.0000112953,-0.0000830882,-0.0000189103,
-0.0000773779,-0.0000311678,-0.0000611818,-0.0000435075,-0.0000430129,-0.0000590435,-0.0000323582,-0.0000725313,
-0.0000291385,-0.0000754394,-0.0000281733,-0.0000657070,-0.0000340691,-0.0000520353,-0.0000505233,-0.0000406627,
-0.0000695105,-0.0000279381,-0.0000793129,-0.0000150129,-0.0000806023,-0.0000121537,-0.0000780513,-0.0000218639,
-0.0000695071,-0.0000343919,-0.0000537868,-0.0000469787,-0.0000375544,-0.0000601469,-0.0000298587,-0.0000704854,
-0.0000290689,-0.0000699512,-0.0000297263,-0.0000560881,-0.0000362353,-0.0000407096,-0.0000518436,-0.0000295357,
-0.0000687929,-0.0000182614,-0.0000760371,-0.0000092167,-0.0000755488,-0.0000105999,-0.0000721121,-0.0000225058,
-0.0000642838,-0.0000367771,-0.0000479084,-0.0000464336,-0.0000305740,-0.0000539913,-0.0000218325,-0.0000606545,
-0.0000223157,-0.0000584165,-0.0000270202,-0.0000470588,-0.0000355417,-0.0000343107,-0.0000507849,-0.0000246684,
-0.0000645356,-0.0000160116,-0.0000689149,-0.0000091261,-0.0000657044,-0.0000108619,-0.0000598623,-0.0000220891,
-0.0000511536,-0.0000351402,-0.0000373541,-0.0000434808,-0.0000235143,-0.0000491524,-0.0000179965,-0.0000524186,
-0.0000202376,-0.0000488098,-0.0000262634,-0.0000385193,-0.0000358458,-0.0000278069,-0.0000483996,-0.0000196317,
-0.0000594300,-0.0000131746,-0.0000610735,-0.0000092011,-0.0000567079,-0.0000127332,-0.0000503420,-0.0000236347,
-0.0000412147,-0.0000343739,-0.0000294750,-0.0000411463,-0.0000200127,-0.0000469064,-0.0000187217,-0.0000500664,
-0.0000230520,-0.0000451836,-0.0000278860,-0.0000333638,-0.0000342909,-0.0000223249,-0.0000449297,-0.0000165610,
-0.0000545013,-0.0000136909,-0.0000565078,-0.0000125066,-0.0000521085,-0.0000160731,-0.0000460155,-0.0000261956,
-0.0000390226,-0.0000348618,-0.0000293183,-0.0000398737,-0.0000212853,-0.0000430423,-0.0000211634,-0.0000446687,
-0.0000264693,-0.0000408550,-0.0000319427,-0.0000307845,-0.0000381229,-0.0000211981,-0.0000460080,-0.0000159574,
-0.0000531668,-0.0000138171,-0.0000551063,-0.0000136634,-0.0000516783,-0.0000181121,-0.0000472627,-0.0000270095,
-0.0000417347,-0.0000354866,-0.0000334921,-0.0000403905,-0.0000268919,-0.0000427293,-0.0000250924,-0.0000440263,
-0.0000278246,-0.0000407220,-0.0000318348,-0.0000339805,-0.0000369399,-0.0000275263,-0.0000445496,-0.0000239705,
-0.0000509047,-0.0000210519,-0.0000519471,-0.0000188527,-0.0000488657,-0.0000205239,-0.0000447674,-0.0000260673,
-0.0000404345,-0.0000332538,-0.0000355054,-0.0000391814,-0.0000311870,-0.0000432094,-0.0000291277,-0.0000450250,
-0.0000287195,-0.0000425653,-0.0000293497,-0.0000367463,-0.0000327404,-0.0000329220,-0.0000395356,-0.0000303016,
-0.0000458644,-0.0000269842,-0.0000476526,-0.0000237991,-0.0000465952,-0.0000230863,-0.0000452166,-0.0000270170,
-0.0000434490,-0.0000321474,-0.0000387929,-0.0000354127,-0.0000326087,-0.0000378290,-0.0000282558,-0.0000402494,
-0.0000268990,-0.0000409617,-0.0000278496,-0.0000396956,-0.0000303040,-0.0000365221,-0.0000338750,-0.0000320610,
-0.0000375248,-0.0000277409,-0.0000404088,-0.0000245658,-0.0000426786,-0.0000232487,-0.0000426147,-0.0000239781,
-0.0000401871,-0.0000252314,-0.0000355837,-0.0000277638,-0.0000313039,-0.0000322477,-0.0000295918,-0.0000363973,
-0.0000284418,-0.0000384842,-0.0000283740,-0.0000376478,-0.0000295121,-0.0000346081,-0.0000321229,-0.0000304851,
-0.0000349881,-0.0000253777,-0.0000372550,-0.0000209722,-0.0000380501,-0.0000189880,-0.0000379272,-0.0000195489,
-0.0000363935,-0.0000223762,-0.0000333080,-0.0000264751,-0.0000295498,-0.0000301992,-0.0000253808,-0.0000331058,
-0.0000226113,-0.0000341002,-0.0000221338,-0.0000337042,-0.0000241594,-0.0000308588,-0.0000268203,-0.0000259525,
-0.0000291968,-0.0000208009,-0.0000322119,-0.0000179449,-0.0000348682,-0.0000182360,-0.0000360143,-0.0000198661,
-0.0000340358,-0.0000226272,-0.0000300281,-0.0000268601,-0.0000258837,-0.0000311815,-0.0000231244,-0.0000347592
};

typedef struct convolver_state
{
	int fftlen;
	int stepsize;
	int buffered_in;
	int buffered_out;
	kiss_fftr_cfg cfg_fw, cfg_bw;
	kiss_fft_cpx *f_out, *f_ir;
	float *revspace, *outspace, *inspace;
} convolver_state;

void * convolver_create(int preset_no)
{
	convolver_state * state;
	int impulse_size;
	const float * impulse;
	int fftlen;
	float * impulse_temp;
	switch (preset_no)
	{
	default:
		impulse_size = null_impulse_size;
		impulse = null_impulse;
		break;

	case 1:
		impulse_size = ess_impulse_size;
		impulse = ess_impulse;
		break;
	}
	state = (convolver_state *) calloc( 1, sizeof( convolver_state ) );

	if ( !state )
		return NULL;

	fftlen = ( impulse_size * 3 ) / 2 + 10000;
	{
		// round up to a power of two
		int pow = 1;
		while ( fftlen > 2 ) { pow++; fftlen /= 2; }
		fftlen = 2 << pow;
	}

	if ( fftlen < 32768 )
		fftlen = 32768;

	if ( fftlen > 1024 + impulse_size + 10 )
	{
		int current;

		fftlen = 1024 + impulse_size + 10;

#define TRYFACTOR(n) if ( failed && current*n > fftlen ) { current *= n; failed = 0; }
		
		current = 1;
		while ( current < fftlen )
		{
			int failed = 1;
			TRYFACTOR(2)
			TRYFACTOR(3)
			TRYFACTOR(5)
			TRYFACTOR(6)
			TRYFACTOR(9)
			TRYFACTOR(10)
			TRYFACTOR(12)
			TRYFACTOR(15)
			TRYFACTOR(18)
			TRYFACTOR(20)
			TRYFACTOR(25)
			TRYFACTOR(30)
			TRYFACTOR(36)
			TRYFACTOR(45)
			TRYFACTOR(75)
			if ( failed )
				current *= 4;
		}
#undef TRYFACTOR

		fftlen = current;
	}

	state->fftlen = fftlen;
	state->stepsize = fftlen - impulse_size - 10;
	state->buffered_in = 0;
	state->buffered_out = 0;

	if ( (state->f_out = (kiss_fft_cpx*) KISS_FFT_MALLOC(sizeof(kiss_fft_cpx) * (fftlen/2+1))) == NULL )
		goto error;
	if ( (state->f_ir = (kiss_fft_cpx*) KISS_FFT_MALLOC(sizeof(kiss_fft_cpx) * (fftlen/2+1))) == NULL )
		goto error;
	if ( (state->revspace = (float *) KISS_FFT_MALLOC(sizeof(float) * fftlen)) == NULL )
		goto error;
	if ( (state->outspace = (float *) calloc(1, sizeof(float) * fftlen)) == NULL )
		goto error;
	if ( (state->inspace = (float *) calloc(1, sizeof(float) * fftlen)) == NULL )
		goto error;

	if ( (state->cfg_fw = kiss_fftr_alloc( fftlen, 0, NULL, NULL )) == NULL )
		goto error;
	if ( (state->cfg_bw = kiss_fftr_alloc( fftlen, 1, NULL, NULL )) == NULL )
		goto error;

	if ( (impulse_temp = (float*) malloc( sizeof(float) * fftlen )) == NULL )
		goto error;

	memcpy( impulse_temp, impulse, impulse_size * sizeof(float) );
	memset( impulse_temp + impulse_size, 0, sizeof(float) * (fftlen - impulse_size) );

	kiss_fftr( state->cfg_fw, impulse_temp, state->f_ir );

	free( impulse_temp );

	return state;

error:
	convolver_delete( state );
	return NULL;
}

void convolver_delete( void * state_ )
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		if ( state->cfg_fw )
			kiss_fftr_free( state->cfg_fw );
		if ( state->cfg_bw )
			kiss_fftr_free( state->cfg_bw );
		if ( state->f_ir )
			KISS_FFT_FREE( state->f_ir );
		if ( state->f_out )
			KISS_FFT_FREE( state->f_out );
		if ( state->revspace )
			KISS_FFT_FREE( state->revspace );
		if ( state->outspace )
			free( state->outspace );
		if ( state->inspace )
			free( state->inspace );
		free( state );
	}
}

void convolver_clear( void * state_ )
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		state->buffered_in = 0;
		state->buffered_out = 0;
		memset( state->inspace, 0, sizeof(float) * state->fftlen );
		memset( state->outspace, 0, sizeof(float) * state->fftlen );
	}
}

int convolver_get_free_count(void * state_)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		return state->stepsize - state->buffered_in;
	}
	return 0;
}

int convolver_ready(void * state_)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		return state->buffered_out;
	}
	return 0;
}

void convolver_write(void * state_, short sample)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		state->inspace[ state->buffered_in++ ] = sample;
		if ( state->buffered_in == state->stepsize )
		{
			int i, fftlen;
			float fftlen_if;
			kiss_fft_cpx *f_ir = state->f_ir;
			kiss_fft_cpx *f_out = state->f_out;
			float *outspace = state->outspace;
			float *revspace = state->revspace;

			kiss_fftr( state->cfg_fw, state->inspace, state->f_out );

			for ( i = 0, fftlen = state->fftlen / 2 + 1; i < fftlen; ++i )
			{
				float re = f_ir[i].r * f_out[i].r - f_ir[i].i * f_out[i].i;
				float im = f_ir[i].i * f_out[i].r + f_ir[i].r * f_out[i].i;
				f_out[i].r = re;
				f_out[i].i = im;
			}

			kiss_fftri( state->cfg_bw, f_out, revspace );

			for (i = 0, fftlen = state->fftlen, fftlen_if = 1.0f / (float)fftlen; i < fftlen; ++i)
				outspace[i] += revspace[i] * fftlen_if;

			state->buffered_out = state->stepsize;
			state->buffered_in = 0;
		}
	}
}

short convolver_read(void *state_)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;

		if ( state->buffered_out )
		{
			int sample_clipped = (int) state->outspace[state->stepsize - state->buffered_out];
			if ( --state->buffered_out == 0 )
			{
				memmove( state->outspace, state->outspace + state->stepsize, (state->fftlen - state->stepsize) * sizeof(float) );
				memset( state->outspace + state->fftlen - state->stepsize, 0, state->stepsize * sizeof(float) );
			}
			if ( (unsigned)( sample_clipped + 0x8000 ) & 0xffff0000 )
				sample_clipped = ( sample_clipped >> 31 ) ^ 0x7fff;
			return sample_clipped;
		}
	}
	return 0;
}
