#include "simple_convolver.h"

#include <stdlib.h>
#include <string.h>
#include <math.h>

#include "kissfft/kiss_fftr.h"

enum { null_impulse_size = 1 };

static const float null_impulse[null_impulse_size] = { 1.0 };

enum { ess_impulse_size = 1024 };

static const float ess_impulse[ess_impulse_size] =
{
 0.0763012653, 0.3176390469, 0.0565480343, 0.1613047846, 0.0056426337, 0.0747253179, 0.0324860513, 0.0290328350,
 0.0403127240, 0.0085922272, 0.0442602140,-0.0026332281, 0.0426302017,-0.0073859138, 0.0361188086,-0.0074352124,
 0.0274578770,-0.0039519144, 0.0202055589, 0.0009374122, 0.0114906178, 0.0047901499, 0.0041602069, 0.0084171741,
-0.0009457578, 0.0098613972,-0.0051809663, 0.0097576598,-0.0071521260, 0.0087561388,-0.0077014592, 0.0069232491,
-0.0068682812, 0.0048945085,-0.0051178375, 0.0027113392,-0.0032986688, 0.0002317826,-0.0020034381,-0.0021042188,
-0.0012157949,-0.0039521149,-0.0009058676,-0.0051480437,-0.0009815418,-0.0057132746,-0.0013696434,-0.0058715293,
-0.0021371746,-0.0058659633,-0.0031941478,-0.0057583473,-0.0042294241,-0.0054655747,-0.0049673795,-0.0050462885,
-0.0053326221,-0.0046727031,-0.0054405973,-0.0044644261,-0.0054654386,-0.0044912872,-0.0054777666,-0.0047248025,
-0.0054686378,-0.0050582105,-0.0054364471,-0.0053588945,-0.0053877341,-0.0056174028,-0.0053277271,-0.0057701423,
-0.0053552774,-0.0057916331,-0.0054092661,-0.0057797297,-0.0054353052,-0.0056677354,-0.0054601945,-0.0054873495,
-0.0054372789,-0.0053172694,-0.0053831372,-0.0051589345,-0.0053657091,-0.0050644322,-0.0053129842,-0.0051035419,
-0.0052838826,-0.0051387116,-0.0052940585,-0.0052324273,-0.0052474169,-0.0053112161,-0.0052352193,-0.0052990089,
-0.0051837375,-0.0052980144,-0.0050872958,-0.0051992048,-0.0050281483,-0.0050754489,-0.0049135370,-0.0049122732,
-0.0048303727,-0.0047529579,-0.0047176951,-0.0045933050,-0.0046216922,-0.0044791814,-0.0045147842,-0.0043707268,
-0.0044097202,-0.0042823424,-0.0042999648,-0.0041970502,-0.0041667290,-0.0040958029,-0.0040311033,-0.0040026175,
-0.0038805928,-0.0038663749,-0.0037281147,-0.0037331956,-0.0035956450,-0.0035777290,-0.0034569345,-0.0034231716,
-0.0033388306,-0.0032925209,-0.0032373222,-0.0031696417,-0.0031400781,-0.0030557911,-0.0030560003,-0.0029660697,
-0.0029760982,-0.0028775331,-0.0028673728,-0.0027872897,-0.0027693908,-0.0027100355,-0.0026520745,-0.0026039023,
-0.0025267560,-0.0024934005,-0.0024080637,-0.0023737508,-0.0022784576,-0.0022490337,-0.0021451641,-0.0021106186,
-0.0020235854,-0.0019752171,-0.0019063254,-0.0018368111,-0.0017777044,-0.0016987858,-0.0016638732,-0.0015729612,
-0.0015351655,-0.0014479369,-0.0014070662,-0.0013306020,-0.0012966982,-0.0012200114,-0.0011679889,-0.0011116303,
-0.0010532616,-0.0010070577,-0.0009454524,-0.0009094495,-0.0008328834,-0.0008144562,-0.0007476762,-0.0007177418,
-0.0006630353,-0.0006302453,-0.0005776020,-0.0005483527,-0.0005146854,-0.0004647331,-0.0004359290,-0.0003908761,
-0.0003629550,-0.0003147723,-0.0003036452,-0.0002472986,-0.0002222969,-0.0001757639,-0.0001485616,-0.0001047012,
-0.0000699789,-0.0000383888, 0.0000111638, 0.0000432041, 0.0000917609, 0.0001204011, 0.0001736531, 0.0002040058,
 0.0002561495, 0.0002896926, 0.0003425803, 0.0003754864, 0.0004200056, 0.0004631763, 0.0005023713, 0.0005485484,
 0.0005790504, 0.0006312821, 0.0006591404, 0.0007055742, 0.0007346649, 0.0007812761, 0.0008107985, 0.0008470008,
 0.0008771036, 0.0009122256, 0.0009431361, 0.0009715798, 0.0010066925, 0.0010310790, 0.0010691102, 0.0010856629,
 0.0011222822, 0.0011409855, 0.0011728795, 0.0011953394, 0.0012238790, 0.0012484868, 0.0012748458, 0.0013029251,
 0.0013222568, 0.0013485001, 0.0013660571, 0.0013940438, 0.0014122642, 0.0014433253, 0.0014604653, 0.0014922357,
 0.0015126407, 0.0015361129, 0.0015566528, 0.0015760202, 0.0015999611, 0.0016187294, 0.0016458089, 0.0016606997,
 0.0016880864, 0.0017083184, 0.0017316248, 0.0017461400, 0.0017694659, 0.0017836015, 0.0018027215, 0.0018201263,
 0.0018327808, 0.0018488702, 0.0018637631, 0.0018822748, 0.0018896111, 0.0019107400, 0.0019188032, 0.0019311406,
 0.0019408611, 0.0019509291, 0.0019556726, 0.0019639200, 0.0019707856, 0.0019749633, 0.0019851023, 0.0019924051,
 0.0019995818, 0.0020018369, 0.0020135932, 0.0020133429, 0.0020193109, 0.0020197928, 0.0020208982, 0.0020214971,
 0.0020254929, 0.0020313459, 0.0020314030, 0.0020366619, 0.0020407575, 0.0020458195, 0.0020460982, 0.0020502524,
 0.0020479980, 0.0020489118, 0.0020466644, 0.0020500081, 0.0020498981, 0.0020501971, 0.0020542322, 0.0020543956,
 0.0020582082, 0.0020584427, 0.0020627824, 0.0020625058, 0.0020620554, 0.0020595901, 0.0020602103, 0.0020580206,
 0.0020578986, 0.0020572044, 0.0020559576, 0.0020548537, 0.0020548519, 0.0020577474, 0.0020553933, 0.0020546890,
 0.0020489331, 0.0020467630, 0.0020423892, 0.0020380352, 0.0020342856, 0.0020297809, 0.0020243609, 0.0020204904,
 0.0020189491, 0.0020150448, 0.0020097917, 0.0020034616, 0.0019985854, 0.0019909499, 0.0019858021, 0.0019772667,
 0.0019705118, 0.0019635015, 0.0019553861, 0.0019483710, 0.0019410247, 0.0019333262, 0.0019229300, 0.0019148864,
 0.0019060625, 0.0018962046, 0.0018875727, 0.0018777040, 0.0018655906, 0.0018573828, 0.0018464929, 0.0018340308,
 0.0018227093, 0.0018102601, 0.0017972808, 0.0017848918, 0.0017746718, 0.0017614744, 0.0017497556, 0.0017389024,
 0.0017245740, 0.0017116733, 0.0016994819, 0.0016841055, 0.0016688588, 0.0016536608, 0.0016384375, 0.0016234208,
 0.0016105395, 0.0015970971, 0.0015812767, 0.0015681139, 0.0015544144, 0.0015385444, 0.0015237314, 0.0015078270,
 0.0014915463, 0.0014751014, 0.0014588692, 0.0014433530, 0.0014275711, 0.0014148278, 0.0014003837, 0.0013843365,
 0.0013693025, 0.0013549816, 0.0013394479, 0.0013231771, 0.0013076861, 0.0012919279, 0.0012758834, 0.0012610308,
 0.0012464764, 0.0012315260, 0.0012182791, 0.0012040666, 0.0011909051, 0.0011750859, 0.0011604683, 0.0011462435,
 0.0011304883, 0.0011151859, 0.0011004854, 0.0010866288, 0.0010718591, 0.0010587496, 0.0010458703, 0.0010329201,
 0.0010190428, 0.0010062335, 0.0009920256, 0.0009791200, 0.0009645238, 0.0009503779, 0.0009364352, 0.0009215578,
 0.0009087980, 0.0008952356, 0.0008827174, 0.0008679778, 0.0008556414, 0.0008429399, 0.0008289017, 0.0008144782,
 0.0008010494, 0.0007860201, 0.0007724829, 0.0007589138, 0.0007443534, 0.0007312261, 0.0007170256, 0.0007046719,
 0.0006907715, 0.0006785059, 0.0006630106, 0.0006494813, 0.0006362588, 0.0006207959, 0.0006056209, 0.0005912144,
 0.0005757698, 0.0005602135, 0.0005466230, 0.0005313513, 0.0005172509, 0.0005021879, 0.0004885280, 0.0004723772,
 0.0004592940, 0.0004444209, 0.0004287531, 0.0004147819, 0.0003996690, 0.0003844701, 0.0003688776, 0.0003548896,
 0.0003386266, 0.0003238800, 0.0003084226, 0.0002940303, 0.0002784593, 0.0002645088, 0.0002482050, 0.0002322797,
 0.0002174357, 0.0002025860, 0.0001881632, 0.0001722111, 0.0001585625, 0.0001421760, 0.0001283198, 0.0001139907,
 0.0000999510, 0.0000848781, 0.0000710359, 0.0000565275, 0.0000422520, 0.0000283135, 0.0000135039,-0.0000015788,
-0.0000177125,-0.0000312602,-0.0000464424,-0.0000594549,-0.0000746767,-0.0000882229,-0.0001030209,-0.0001168592,
-0.0001295960,-0.0001434294,-0.0001569099,-0.0001701222,-0.0001820177,-0.0001954588,-0.0002077274,-0.0002209121,
-0.0002331039,-0.0002477060,-0.0002600140,-0.0002736450,-0.0002864419,-0.0002991661,-0.0003129935,-0.0003256256,
-0.0003393358,-0.0003514725,-0.0003649007,-0.0003770587,-0.0003904802,-0.0004017121,-0.0004130062,-0.0004242749,
-0.0004365412,-0.0004466860,-0.0004578354,-0.0004695891,-0.0004798949,-0.0004920344,-0.0005028597,-0.0005150244,
-0.0005258842,-0.0005385690,-0.0005497496,-0.0005620520,-0.0005744249,-0.0005864368,-0.0005984991,-0.0006104460,
-0.0006212434,-0.0006316938,-0.0006436447,-0.0006530691,-0.0006633378,-0.0006728522,-0.0006831856,-0.0006914906,
-0.0007019252,-0.0007117414,-0.0007209450,-0.0007309639,-0.0007404022,-0.0007505010,-0.0007603930,-0.0007711963,
-0.0007807147,-0.0007911233,-0.0008009746,-0.0008113935,-0.0008205894,-0.0008310856,-0.0008400412,-0.0008485593,
-0.0008575008,-0.0008654422,-0.0008732706,-0.0008802220,-0.0008888403,-0.0008957729,-0.0009034587,-0.0009106652,
-0.0009179206,-0.0009252790,-0.0009333024,-0.0009402468,-0.0009472541,-0.0009544823,-0.0009618958,-0.0009696699,
-0.0009766825,-0.0009848416,-0.0009912370,-0.0009983357,-0.0010046186,-0.0010110138,-0.0010166290,-0.0010217966,
-0.0010273701,-0.0010325604,-0.0010375498,-0.0010426245,-0.0010476083,-0.0010519543,-0.0010571270,-0.0010615254,
-0.0010658422,-0.0010693106,-0.0010740099,-0.0010778516,-0.0010816878,-0.0010863411,-0.0010902895,-0.0010945872,
-0.0010986030,-0.0011025796,-0.0011062231,-0.0011098553,-0.0011128888,-0.0011161234,-0.0011189254,-0.0011215564,
-0.0011241023,-0.0011272591,-0.0011293652,-0.0011313340,-0.0011343450,-0.0011363591,-0.0011382851,-0.0011401431,
-0.0011417906,-0.0011427546,-0.0011442589,-0.0011459300,-0.0011470690,-0.0011487789,-0.0011504768,-0.0011516586,
-0.0011536815,-0.0011554235,-0.0011566993,-0.0011581167,-0.0011587314,-0.0011593090,-0.0011603356,-0.0011614552,
-0.0011615165,-0.0011615511,-0.0011626272,-0.0011630923,-0.0011633368,-0.0011636892,-0.0011632105,-0.0011625047,
-0.0011616699,-0.0011612581,-0.0011602858,-0.0011595798,-0.0011594865,-0.0011588627,-0.0011587814,-0.0011592514,
-0.0011592062,-0.0011591057,-0.0011585882,-0.0011575693,-0.0011569631,-0.0011563403,-0.0011556891,-0.0011539518,
-0.0011530224,-0.0011520554,-0.0011506896,-0.0011495734,-0.0011480247,-0.0011462337,-0.0011439992,-0.0011420077,
-0.0011398870,-0.0011377620,-0.0011356040,-0.0011339338,-0.0011319412,-0.0011306484,-0.0011290064,-0.0011276125,
-0.0011258837,-0.0011239101,-0.0011222985,-0.0011197948,-0.0011178279,-0.0011154550,-0.0011128128,-0.0011096630,
-0.0011071213,-0.0011039475,-0.0011005705,-0.0010974425,-0.0010944495,-0.0010908801,-0.0010876175,-0.0010845761,
-0.0010810255,-0.0010782819,-0.0010748251,-0.0010719664,-0.0010687275,-0.0010660340,-0.0010626731,-0.0010593007,
-0.0010558869,-0.0010522771,-0.0010492432,-0.0010457905,-0.0010418678,-0.0010380879,-0.0010344990,-0.0010296959,
-0.0010257913,-0.0010211953,-0.0010165125,-0.0010115012,-0.0010074116,-0.0010029696,-0.0009983386,-0.0009945422,
-0.0009900865,-0.0009861852,-0.0009820393,-0.0009779779,-0.0009735090,-0.0009693746,-0.0009645500,-0.0009598972,
-0.0009546702,-0.0009496814,-0.0009443863,-0.0009395988,-0.0009350787,-0.0009293859,-0.0009245008,-0.0009191445,
-0.0009139129,-0.0009081015,-0.0009028459,-0.0008969358,-0.0008910678,-0.0008857315,-0.0008805797,-0.0008750561,
-0.0008699965,-0.0008651117,-0.0008596073,-0.0008545530,-0.0008489869,-0.0008438650,-0.0008378749,-0.0008322014,
-0.0008258237,-0.0008196113,-0.0008135331,-0.0008070382,-0.0008007568,-0.0007946393,-0.0007886406,-0.0007822760,
-0.0007762484,-0.0007699110,-0.0007638019,-0.0007572049,-0.0007510554,-0.0007444988,-0.0007383163,-0.0007321524,
-0.0007261904,-0.0007202722,-0.0007139334,-0.0007083274,-0.0007019651,-0.0006953168,-0.0006885978,-0.0006821233,
-0.0006752591,-0.0006684652,-0.0006613674,-0.0006541888,-0.0006470961,-0.0006404240,-0.0006332762,-0.0006259600,
-0.0006193168,-0.0006120462,-0.0006052170,-0.0005983414,-0.0005915006,-0.0005844276,-0.0005774518,-0.0005705030,
-0.0005635656,-0.0005568457,-0.0005499022,-0.0005428917,-0.0005361654,-0.0005290849,-0.0005219861,-0.0005152803,
-0.0005075860,-0.0004999624,-0.0004924989,-0.0004850415,-0.0004775219,-0.0004700486,-0.0004626004,-0.0004547663,
-0.0004474050,-0.0004403015,-0.0004327207,-0.0004252771,-0.0004179083,-0.0004103594,-0.0004028795,-0.0003955443,
-0.0003882855,-0.0003807068,-0.0003732636,-0.0003658949,-0.0003585558,-0.0003515157,-0.0003440205,-0.0003363262,
-0.0003290020,-0.0003213942,-0.0003137492,-0.0003061270,-0.0002985799,-0.0002906160,-0.0002827521,-0.0002753204,
-0.0002674489,-0.0002597725,-0.0002523485,-0.0002448035,-0.0002370418,-0.0002296432,-0.0002222875,-0.0002148371,
-0.0002073204,-0.0001999953,-0.0001923027,-0.0001848585,-0.0001774633,-0.0001698965,-0.0001625979,-0.0001549183,
-0.0001476597,-0.0001402783,-0.0001330365,-0.0001255918,-0.0001180655,-0.0001105116,-0.0001030327,-0.0000954767,
-0.0000879435,-0.0000804087,-0.0000729568,-0.0000656212,-0.0000582655,-0.0000513485,-0.0000436067,-0.0000363740,
-0.0000292473,-0.0000220916,-0.0000147126,-0.0000075743,-0.0000005769, 0.0000067113, 0.0000135827, 0.0000206152,
 0.0000278073, 0.0000348088, 0.0000416155, 0.0000489606, 0.0000556983, 0.0000627811, 0.0000695959, 0.0000764024,
 0.0000831999, 0.0000899697, 0.0000967918, 0.0001033491, 0.0001103513, 0.0001169535, 0.0001237696, 0.0001305055,
 0.0001372145, 0.0001436813, 0.0001503207, 0.0001564756, 0.0001628687, 0.0001695126, 0.0001760660, 0.0001823622,
 0.0001886336, 0.0001954235, 0.0002015383, 0.0002080568, 0.0002144165, 0.0002207535, 0.0002268730, 0.0002331765,
 0.0002392641, 0.0002452733, 0.0002515171, 0.0002576490, 0.0002635783, 0.0002695158, 0.0002756092, 0.0002813940,
 0.0002874976, 0.0002931117, 0.0002988329, 0.0003044006, 0.0003101964, 0.0003158339, 0.0003214024, 0.0003271827,
 0.0003325037, 0.0003380834, 0.0003437309, 0.0003490852, 0.0003543177, 0.0003599355, 0.0003652328, 0.0003704748,
 0.0003756595, 0.0003811246, 0.0003862842, 0.0003915333, 0.0003970242, 0.0004022737, 0.0004076246, 0.0004126215,
 0.0004177090, 0.0004226801, 0.0004276137, 0.0004326217, 0.0004375268, 0.0004423284, 0.0004473190, 0.0004523174,
 0.0004573079, 0.0004620916, 0.0004667976, 0.0004713921, 0.0004758063, 0.0004805540, 0.0004849929, 0.0004894970,
 0.0004941077, 0.0004984037, 0.0005029036, 0.0005076446, 0.0005121222, 0.0005163518, 0.0005206643, 0.0005248849,
 0.0005287968, 0.0005329802, 0.0005370337, 0.0005407941, 0.0005448338, 0.0005489762, 0.0005531195, 0.0005572535,
 0.0005611838, 0.0005650527, 0.0005688618, 0.0005726460, 0.0005763937, 0.0005800843, 0.0005839118, 0.0005874838,
 0.0005913959, 0.0005953093, 0.0005991107, 0.0006028874, 0.0006065607, 0.0006101127, 0.0006135691, 0.0006171599,
 0.0006205577, 0.0006239269, 0.0006274268, 0.0006307947, 0.0006339066, 0.0006374893, 0.0006408266, 0.0006440732,
 0.0006471862, 0.0006502785, 0.0006532588, 0.0006560922, 0.0006592231, 0.0006618425, 0.0006645037, 0.0006673565,
 0.0006702922, 0.0006730254, 0.0006758291, 0.0006783911, 0.0006810448, 0.0006835953, 0.0006861021, 0.0006884764,
 0.0006909267, 0.0006935087, 0.0006956923, 0.0006983492, 0.0007007665, 0.0007032022, 0.0007055739, 0.0007079719,
 0.0007102181, 0.0007124911, 0.0007148042, 0.0007169653, 0.0007190615, 0.0007213044, 0.0007235273, 0.0007253607,
 0.0007274286, 0.0007292715, 0.0007313611, 0.0007331071, 0.0007349862, 0.0007368794, 0.0007385993, 0.0007403126,
 0.0007420102, 0.0007436389, 0.0007449887, 0.0007466084, 0.0007481058, 0.0007494397, 0.0007506980, 0.0007520796,
 0.0007531321, 0.0007544313, 0.0007554606, 0.0007563432, 0.0007574057, 0.0007583454, 0.0007591961, 0.0007599247,
};

typedef struct convolver_state
{
	int fftlen;
	int stepsize;
	int buffered_in;
	int buffered_out;
	kiss_fftr_cfg cfg_fw, cfg_bw;
	kiss_fft_cpx *f_out, *f_ir;
	float *revspace, *outspace, *inspace;
} convolver_state;

void * convolver_create(int preset_no)
{
	convolver_state * state;
	int impulse_size;
	const float * impulse;
	int fftlen;
	float * impulse_temp;
	switch (preset_no)
	{
	default:
		impulse_size = null_impulse_size;
		impulse = null_impulse;
		break;

	case 1:
		impulse_size = ess_impulse_size;
		impulse = ess_impulse;
		break;
	}
	state = (convolver_state *) calloc( 1, sizeof( convolver_state ) );

	if ( !state )
		return NULL;

	fftlen = ( impulse_size * 3 ) / 2 + 10000;
	{
		// round up to a power of two
		int pow = 1;
		while ( fftlen > 2 ) { pow++; fftlen /= 2; }
		fftlen = 2 << pow;
	}

	if ( fftlen < 32768 )
		fftlen = 32768;

	if ( fftlen > 1024 + impulse_size + 10 )
	{
		int current;

		fftlen = 1024 + impulse_size + 10;

#define TRYFACTOR(n) if ( failed && current*n > fftlen ) { current *= n; failed = 0; }
		
		current = 1;
		while ( current < fftlen )
		{
			int failed = 1;
			TRYFACTOR(2)
			TRYFACTOR(3)
			TRYFACTOR(5)
			TRYFACTOR(6)
			TRYFACTOR(9)
			TRYFACTOR(10)
			TRYFACTOR(12)
			TRYFACTOR(15)
			TRYFACTOR(18)
			TRYFACTOR(20)
			TRYFACTOR(25)
			TRYFACTOR(30)
			TRYFACTOR(36)
			TRYFACTOR(45)
			TRYFACTOR(75)
			if ( failed )
				current *= 4;
		}
#undef TRYFACTOR

		fftlen = current;
	}

	state->fftlen = fftlen;
	state->stepsize = fftlen - impulse_size - 10;
	state->buffered_in = 0;
	state->buffered_out = 0;

	if ( (state->f_out = (kiss_fft_cpx*) KISS_FFT_MALLOC(sizeof(kiss_fft_cpx) * (fftlen/2+1))) == NULL )
		goto error;
	if ( (state->f_ir = (kiss_fft_cpx*) KISS_FFT_MALLOC(sizeof(kiss_fft_cpx) * (fftlen/2+1))) == NULL )
		goto error;
	if ( (state->revspace = (float *) KISS_FFT_MALLOC(sizeof(float) * fftlen)) == NULL )
		goto error;
	if ( (state->outspace = (float *) calloc(1, sizeof(float) * fftlen)) == NULL )
		goto error;
	if ( (state->inspace = (float *) calloc(1, sizeof(float) * fftlen)) == NULL )
		goto error;

	if ( (state->cfg_fw = kiss_fftr_alloc( fftlen, 0, NULL, NULL )) == NULL )
		goto error;
	if ( (state->cfg_bw = kiss_fftr_alloc( fftlen, 1, NULL, NULL )) == NULL )
		goto error;

	if ( (impulse_temp = (float*) malloc( sizeof(float) * fftlen )) == NULL )
		goto error;

	memcpy( impulse_temp, impulse, impulse_size * sizeof(float) );
	memset( impulse_temp + impulse_size, 0, sizeof(float) * (fftlen - impulse_size) );

	kiss_fftr( state->cfg_fw, impulse_temp, state->f_ir );

	free( impulse_temp );

	return state;

error:
	convolver_delete( state );
	return NULL;
}

void convolver_delete( void * state_ )
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		if ( state->cfg_fw )
			kiss_fftr_free( state->cfg_fw );
		if ( state->cfg_bw )
			kiss_fftr_free( state->cfg_bw );
		if ( state->f_ir )
			KISS_FFT_FREE( state->f_ir );
		if ( state->f_out )
			KISS_FFT_FREE( state->f_out );
		if ( state->revspace )
			KISS_FFT_FREE( state->revspace );
		if ( state->outspace )
			free( state->outspace );
		if ( state->inspace )
			free( state->inspace );
		free( state );
	}
}

void convolver_clear( void * state_ )
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		state->buffered_in = 0;
		state->buffered_out = 0;
		memset( state->inspace, 0, sizeof(float) * state->fftlen );
		memset( state->outspace, 0, sizeof(float) * state->fftlen );
	}
}

int convolver_get_free_count(void * state_)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		return state->stepsize - state->buffered_in;
	}
	return 0;
}

int convolver_ready(void * state_)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		return state->buffered_out;
	}
	return 0;
}

void convolver_write(void * state_, short sample)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;
		state->inspace[ state->buffered_in++ ] = sample;
		if ( state->buffered_in == state->stepsize )
		{
			int i, fftlen;
			float fftlen_if;
			kiss_fft_cpx *f_ir = state->f_ir;
			kiss_fft_cpx *f_out = state->f_out;
			float *outspace = state->outspace;
			float *revspace = state->revspace;

			kiss_fftr( state->cfg_fw, state->inspace, state->f_out );

			for ( i = 0, fftlen = state->fftlen / 2 + 1; i < fftlen; ++i )
			{
				float re = f_ir[i].r * f_out[i].r - f_ir[i].i * f_out[i].i;
				float im = f_ir[i].i * f_out[i].r + f_ir[i].r * f_out[i].i;
				f_out[i].r = re;
				f_out[i].i = im;
			}

			kiss_fftri( state->cfg_bw, f_out, revspace );

			for (i = 0, fftlen = state->fftlen, fftlen_if = 1.0f / (float)fftlen; i < fftlen; ++i)
				outspace[i] += revspace[i] * fftlen_if;

			state->buffered_out = state->stepsize;
			state->buffered_in = 0;
		}
	}
}

short convolver_read(void *state_)
{
	if ( state_ )
	{
		convolver_state * state = (convolver_state *) state_;

		if ( state->buffered_out )
		{
			int sample_clipped = (int) state->outspace[state->stepsize - state->buffered_out];
			if ( --state->buffered_out == 0 )
			{
				memmove( state->outspace, state->outspace + state->stepsize, (state->fftlen - state->stepsize) * sizeof(float) );
				memset( state->outspace + state->fftlen - state->stepsize, 0, state->stepsize * sizeof(float) );
			}
			if ( (unsigned)( sample_clipped + 0x8000 ) & 0xffff0000 )
				sample_clipped = ( sample_clipped >> 31 ) ^ 0x7fff;
			return sample_clipped;
		}
	}
	return 0;
}
